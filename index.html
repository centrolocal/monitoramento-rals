<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RALSCOPE</title>
  <style>
    :root{
      /* ====== Dark (default) ====== */
      --bg:#0b0b0b;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#2a2a2a;
      --card1:#141414;
      --card2:#101010;
      --shadow: rgba(0,0,0,.60);
      --accent: rgba(122,162,255,.35);

      /* Manchester palette */
      --m-red:    #e53935;
      --m-orange: #fb8c00;
      --m-yellow: #fdd835;
      --m-green:  #43a047;
      --m-blue:   #1e88e5;
      --m-black:  #000000;

      /* SLA highlight (corporativo) */
      --sla24-bg: rgba(253,216,53,.10);
      --sla48-bg: rgba(251,140,0,.10);
      --sla72-bg: rgba(229,57,53,.10);


      --btn-bg: rgba(255,255,255,.06);
      --btn-bg2: rgba(255,255,255,.04);
      --btn-border: rgba(255,255,255,.10);

      --head-bg: rgba(15,18,33,.92);
    }

    /* ====== Light (clean) ====== */
    body[data-theme="light"]{
      --bg:#f6f7fb;
      --text:#0d1321;
      --muted:#5b6472;
      --line: rgba(13,19,33,.12);
      --card1: rgba(255,255,255,.85);
      --card2: rgba(255,255,255,.75);
      --shadow: rgba(20,25,35,.10);
      --accent: rgba(30,136,229,.22);

      --btn-bg: rgba(13,19,33,.06);
      --btn-bg2: rgba(13,19,33,.04);
      --btn-border: rgba(13,19,33,.12);

      /* SLA highlight (corporativo) */
      --sla24-bg: rgba(253,216,53,.18);
      --sla48-bg: rgba(251,140,0,.18);
      --sla72-bg: rgba(229,57,53,.16);

      --head-bg: rgba(246,247,251,.92);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0; padding:18px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(255,255,255,.04), transparent 60%),
        radial-gradient(1200px 700px at 90% 20%, rgba(255,255,255,.03), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    body[data-theme="light"]{
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(30,136,229,.12), transparent 60%),
        radial-gradient(1200px 700px at 90% 20%, rgba(67,160,71,.10), transparent 60%),
        var(--bg);
    }

    .wrap{ max-width:1500px; margin:0 auto; }
    header{ display:flex; flex-wrap:wrap; gap:14px; justify-content:space-between; align-items:flex-start; margin-bottom:14px; }
    h1{ margin:0; font-size:20px; }
    .sub{ margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35; }

    .pill{
      display:inline-flex; gap:8px; align-items:center;
      background: var(--btn-bg2);
      border:1px solid var(--line);
      border-radius:999px;
      padding:8px 10px;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }

    .card{
      background: linear-gradient(180deg, var(--card1), var(--card2));
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow: 0 10px 30px var(--shadow);
    }

    .grid{ display:grid; grid-template-columns: 1fr; gap:14px; align-items:start; }
    
    /* ====== RAW + CHART SPLIT ====== */
    .rawSplit{
      display:grid;
      grid-template-columns: minmax(0, 1fr) 420px;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .rawSplit{ grid-template-columns: 1fr; }
    }
@media (max-width: 980px){ .grid{ grid-template-columns: 1fr; } }

    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    textarea, input{
      width:100%;
      background: var(--btn-bg2);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:10px;
      padding:10px;
      outline:none;
    }
    textarea:focus, input:focus{ border-color: var(--accent); }
    textarea{
      min-height: 150px; resize: vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
    }

    .actions{ display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
    button{
      border:1px solid var(--btn-border);
      background: var(--btn-bg);
      color:var(--text);
      padding:10px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:800;
      letter-spacing:.2px;
    }
    button:hover{ border-color: rgba(255,255,255,.22); }
    body[data-theme="light"] button:hover{ border-color: rgba(13,19,33,.22); }
    button.primary{ border-color: rgba(30,136,229,.40); background: rgba(30,136,229,.16); }
    button.danger{ border-color: rgba(229,57,53,.40); background: rgba(229,57,53,.12); }
    button.ghost{ background: transparent; }

    .hint{ margin-top:10px; font-size:12px; color:var(--muted); line-height:1.35; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted{ color:var(--muted); }

    /* ====== TABLE ====== */
    .tablewrap{
      overflow:auto;
      border-radius: 12px;
      border: 1px solid var(--line);
      margin-top: 12px;
    }
    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      min-width: 0;
      table-layout: auto;
    }
    colgroup col.col-age { width: 18%; }
    colgroup col.col-ral { width: 16%; }
    colgroup col.col-des { width: 34%; }
    colgroup col.col-cf  { width: 20%; }
    colgroup col.col-act { width: 12%; }

    th, td{
      border-bottom: 1px solid var(--line);
      padding: 10px 12px;
      font-size: 13px;
      vertical-align: middle;
    }

    th{
      position: sticky;
      top: 0;
      background: var(--head-bg);
      backdrop-filter: blur(8px);
      color: var(--muted);
      font-size: 12px;
      letter-spacing: .35px;
      z-index: 1;
      text-align: center;
    }

    th:not(:last-child), td:not(:last-child){
      border-right: 1px solid rgba(255,255,255,.06);
    }
    body[data-theme="light"] th:not(:last-child), body[data-theme="light"] td:not(:last-child){
      border-right: 1px solid rgba(13,19,33,.06);
    }

    tr:hover td{ background: rgba(255,255,255,.03); }
    body[data-theme="light"] tr:hover td{ background: rgba(13,19,33,.03); }

    td:nth-child(1){ text-align: left; } /* idade */
    td:nth-child(2){ text-align: left; } /* ral */
    td:nth-child(3){ text-align: left; } /* designa√ß√£o */
    td:nth-child(4){ text-align: left; } /* cf */
    td:nth-child(5){ text-align: center; }/* a√ß√£o */

    .badge{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:5px 10px;
      font-size:12px;
      white-space:nowrap;
      font-weight: 900;
      background: rgba(255,255,255,.04);
      color: var(--text);
    }
    body[data-theme="light"] .badge{ background: rgba(13,19,33,.04); }

    .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    .ageSub{ margin-top: 6px; font-size: 12px; color: var(--muted); }
    .small{ padding:8px 10px; font-size:12px; font-weight:900; }

    /* ====== CHART ====== */
    .chart{
      display:flex; flex-direction:column; gap:6px;
    }
    .barRow{
      display:grid;
      grid-template-columns: 160px 1fr 40px;
      gap:6px;
      align-items:center;
    }
    @media (max-width: 620px){
      .barRow{ grid-template-columns: 1fr; }
    }
    .barBtn{
      width:100%;
      border:1px solid var(--line);
      background: transparent;
      border-radius:12px;
      padding:10px;
      text-align:left;
      cursor:pointer;
      display:flex; flex-direction:column; gap:8px;
    }
    .barBtn:hover{ border-color: rgba(255,255,255,.22); }
    body[data-theme="light"] .barBtn:hover{ border-color: rgba(13,19,33,.22); }

    .barLabel{ display:flex; align-items:center; gap:10px; font-weight:900; font-size:12px; color: var(--text); }
    .barTrack{
      height:8px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      overflow:hidden;
      border:1px solid var(--line);
    }
    body[data-theme="light"] .barTrack{ background: rgba(13,19,33,.06); }

    .barFill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: var(--m-blue);
    }
    .barMeta{ font-size:12px; color: var(--muted); }

    .selected{
      outline: 2px solid rgba(30,136,229,.38);
      border-color: rgba(30,136,229,.38) !important;
      background: rgba(30,136,229,.08);
    }

    /* ====== OUTPUT ====== */
    .out{
      margin-top:12px;
      display:none;
    }
    .outHeader{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center;
      margin-bottom:8px;
    }
    .outActions{ display:flex; gap:10px; flex-wrap:wrap; }
    .out textarea{ min-height: 120px; }

    /* Sa√≠da TXT/TSV: n√£o quebrar linha (pra colunas ficarem alinhadas) */
    .out textarea{
      min-height: 220px;
      white-space: pre;
      overflow: auto;
      overflow-x: auto;
      font-variant-ligatures: none;
    }
    /* Tabela/planilha na tela: compacta e com quebra dentro da c√©lula */
    #outTable{
      table-layout: fixed;
      width: 100%;
      min-width: 0;
    }
    #outTable th, #outTable td{
      padding: 8px 10px;
      font-size: 12px;
      line-height: 1.15;
      text-align: left;
      vertical-align: top;
    }
    #outTable td{
      overflow-wrap: anywhere;
      word-break: break-word;
    }

  
  /* Sa√≠da (Planilha) mais compacta e UF estreita */
  #outTable { font-size: 12px; }
  #outTable th, #outTable td { padding: 6px 8px; vertical-align: top; }
  #outTable td.ufCol, #outTable th.ufCol { width: 44px; max-width: 44px; white-space: nowrap; }
  #outTable td.cfCol { max-width: 320px; }
  #outTable td { overflow-wrap: anywhere; word-break: break-word; }
  select.statusSel { font-size: 12px; padding: 4px 6px; }

  

  /* PRAZO/STATUS: evitar sobreposi√ß√£o em telas menores */
  #outTable td input.prazoInput, #outTable td select.statusSel{
    width: 100%;
    min-width: 110px;
  }
  #outTable td{ overflow: hidden; }
  #outTable td.prazoCell{ overflow: visible; }
/* Destaque corporativo: ABERTAS acima de 24h (barra lateral + fundo suave) */
  #outTable tr.sla24{ box-shadow: inset 4px 0 0 var(--m-red); }
  #outTable tr.sla48{ box-shadow: inset 4px 0 0 var(--m-red); }
  #outTable tr.sla72{ box-shadow: inset 4px 0 0 var(--m-black); }




/* ====== PRAZO (data) ====== */
/* Objetivo: caber sem esconder o bot√£o do calend√°rio (mesmo com coluna estreita) */
.prazoWrap{ display:flex; align-items:center; min-width: 120px; width:100%; }
.prazoField{ position:relative; flex:1; min-width: 110px; }

/* O bot√£o √© o "visual" da c√©lula */
.prazoBtn{
  width:100%;
  min-height:30px;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  border:1px solid var(--btn-border);
  background: var(--btn-bg2);
  color: var(--text);
  border-radius:10px;
  cursor:pointer;
  font-weight:900;
  padding:6px 8px;
  font-size:12px;
  line-height:1.2;  position:relative;
  z-index:2;
  pointer-events:auto;
}

.prazoBtn:hover{ border-color: rgba(255,255,255,.22); }
body[data-theme="light"] .prazoBtn:hover{ border-color: rgba(13,19,33,.22); }

/* O input fica por cima (transparente) para abrir o calend√°rio nativo ao clicar */
.prazoField input[type="date"]{
  position:absolute; inset:0;
  width:100%; height:100%;
  opacity:0;
  cursor:pointer;
  z-index:1;
  pointer-events:none;
}

/* Texto do bot√£o */
.prazoBtnText{ font-weight:800; opacity:.95; }
.prazoBtnEmpty{ opacity:.70; font-weight:800; }


@media (max-width: 1100px){ }
.rawRight{ border:1px solid var(--line); border-radius:14px; padding:12px; background: rgba(255,255,255,.02); }
body[data-theme="light"] .rawRight{ background: rgba(13,19,33,.02); }
.chart.compact{ gap:6px; }
.chart.compact .barRow{ grid-template-columns: 160px 1fr 40px; gap:6px; }
.chart.compact .barTrack{ height:8px; }


/* ====== Painel de controle compacto (1 linha) ====== */
.controlBar{ padding:12px 14px; margin-top:12px; }

.controlBarInner{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
.controlTitle{ font-weight:900; letter-spacing:.2px; }
.controlBarInner input{
  flex: 1 1 220px;
  min-width: 180px;
  height: 38px;
}
.controlActions{
  margin-left:auto;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}
.controlActions button{
  padding:8px 10px;
  font-size:12px;
}


</style>
</head>

<body>
<div class="wrap">
  <header>
    <div>
      <h1>RALSCOPE</h1>
      <div class="sub">
        Distribui√ß√£o por <b>faixa de idade</b> (SLA) usando a <b>data/hora de abertura</b> como base.
        Gr√°fico clic√°vel para enxergar e filtrar as <b>ofensoras &gt; 24h</b>.
      </div>
    </div>
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <button class="ghost" id="btnTheme" title="Alternar tema">üåì Modo</button>
      <span class="pill">üìå Registros: <strong id="count">0</strong></span>
      <span class="pill">üóìÔ∏è Coleta: <strong id="rangeColeta" class="mono">-</strong></span>
    </div>
  </header>

  <div class="grid">
    <div class="card">
      <h2 style="margin:0 0 10px 0; font-size:14px; color: var(--muted); font-weight:900;">Dados brutos</h2>
      <div class="rawSplit">
      <div class="rawLeft">
      <label for="raw">Cole o bloco aqui</label>
      <textarea id="raw" placeholder=""></textarea>

      <div class="actions">
        <button class="primary" id="btnParse">Importar / Parsear</button>
        <button id="btnTxt">Gerar TXT (na tela)</button>
        <button id="btnXls">Gerar Planilha Excel</button>
        <button id="btnCsv">Gerar CSV (download)</button>
        <button class="danger" id="btnClear">Limpar tudo</button>
        <button class="danger" id="btnResetStatus">Resetar status salvos</button>
      </div>

<div class="out" id="outBox">
        <div class="outHeader">
          <div class="muted" id="outTitle" style="font-weight:900;">Sa√≠da</div>
          <div class="outActions">
            <button id="btnCopyOut">Copiar</button>
            <button id="btnDownloadXls" title="Baixar como .xls (Excel abre)">Baixar XLS</button>
            <button id="btnCloseOut" class="ghost">Fechar</button>
          </div>
        </div>

        <!-- TXT/TSV -->
        <textarea id="outTxt" class="mono" readonly wrap="off"></textarea>

        <!-- Tabela (visual) -->
        <div class="tablewrap" id="outTableWrap" style="display:none; margin-top:10px;">
          <table id="outTable">
            <thead>
              <tr>
                <th>RAL</th>
                <th>PIR√ÇMIDE</th>
                <th class="ufCol">UF</th>
                <th class="cfCol">CF</th>
                <th>FAIXA DE IDADE</th>
                <th>RESPONS√ÅVEL</th>
                <th>PRAZO</th>
                <th>STATUS</th>
              </tr>
            </thead>
            <tbody id="outTbody"></tbody>
          </table>
        </div>

        <div class="hint" id="outHint">Dica: o TXT √© TSV (tabulado). Cola no Excel/Sheets que vira coluna na hora.</div>
    </div>
      </div><!-- /rawLeft -->
      <div class="rawRight">
        <h2 style="margin:0 0 10px 0; font-size:14px; color: var(--muted); font-weight:900;">Gr√°fico: RALs por idade</h2>
        <div class="hint" style="margin-top:-6px; margin-bottom:10px;">Clique em uma barra para filtrar. Clique de novo para soltar.</div>
        <div class="chart compact" id="chart"></div>
      </div><!-- /rawRight -->
      </div><!-- /rawSplit -->


    </div>
  </div>

  <div class="card controlBar">
    <div class="controlBarInner">
      <div class="controlTitle muted">Filtros</div>

      <input id="fDesignacao" placeholder="Designa√ß√£o" aria-label="Designa√ß√£o" />
      <input id="fCF" placeholder="CF" aria-label="CF" />
      <input id="fRAL" class="mono" placeholder="RAL" aria-label="RAL" />

      <div class="controlActions">
        <button id="btnResetFilters">Limpar filtros</button>
        <button id="btnClearRange" class="ghost" title="Remove o filtro de faixa do gr√°fico">Limpar faixa</button>
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:14px;">

    <h2 style="margin:0 0 10px 0; font-size:14px; color: var(--muted); font-weight:900;">Planilha</h2>

    <div class="tablewrap">
      <table>
        <colgroup>
          <col class="col-age">
          <col class="col-ral">
          <col class="col-des">
          <col class="col-cf">
          <col class="col-act">
        </colgroup>
        <thead>
          <tr>
            <th>IDADE</th>
            <th>RAL</th>
            <th>DESIGNA√á√ÉO</th>
            <th class="cfCol">CF</th>
            <th>A√á√ïES</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
</div>

<script>

(() => {
  const STORAGE_KEY = "monitor_rals_v4_upgrade_2026_02";
  const THEME_KEY = "monitor_rals_theme";
  const el = (id) => document.getElementById(id);

  const raw = el("raw");
  const count = el("count");
  const rangeColeta = el("rangeColeta");

  // Status edit√°vel (usado na planilha visual e refletido nas exporta√ß√µes)
  const statusByRal = new Map(); // key: "RAL-12345/2026" -> "ABERTA"|"FECHADA"|"NORMALIZADA"
  const LS_STATUS_KEY = "monral_status_v1";

  function loadStatusMap(){
    try{
      const raw = localStorage.getItem(LS_STATUS_KEY);
      if(!raw) return;
      const obj = JSON.parse(raw);
      if(obj && typeof obj === "object"){
        Object.entries(obj).forEach(([k,v])=>{
          if(typeof k === "string"){
            statusByRal.set(k, (v === "FECHADA" || v === "NORMALIZADA") ? v : "ABERTA");
          }
        });
      }
    }catch(_e){}
  }

  function persistStatusMap(){
    try{
      const obj = Object.fromEntries(statusByRal.entries());
      localStorage.setItem(LS_STATUS_KEY, JSON.stringify(obj));
    }catch(_e){}
  }

  function getStatusForRal(ral){
    return statusByRal.get(ral) || "ABERTA";
  }

  function setStatusForRal(ral, val){
    statusByRal.set(ral, (val === "FECHADA" || val === "NORMALIZADA") ? val : "ABERTA");
    persistStatusMap();
  }


  

// ====== PRAZO (data prevista de normaliza√ß√£o) ======
const prazoByRal = new Map(); // key: "RAL-123/2026" -> "YYYY-MM-DD"
const LS_PRAZO_KEY = "monral_prazo_v1";

function loadPrazoMap(){
  try{
    const raw = localStorage.getItem(LS_PRAZO_KEY);
    if(!raw) return;
    const obj = JSON.parse(raw);
    if(obj && typeof obj === "object"){
      Object.entries(obj).forEach(([k,v])=>{
        if(typeof k === "string" && typeof v === "string"){
          prazoByRal.set(k, v);
        }
      });
    }
  }catch(_e){}
}

function persistPrazoMap(){
  try{
    const obj = Object.fromEntries(prazoByRal.entries());
    localStorage.setItem(LS_PRAZO_KEY, JSON.stringify(obj));
  }catch(_e){}
}

function getPrazoForRal(ral){
  return prazoByRal.get(ral) || "";
}

function setPrazoForRal(ral, val){
  if(!ral) return;
  if(!val){
    prazoByRal.delete(ral);
  }else{
    prazoByRal.set(ral, val);
  }
  persistPrazoMap();
}

function clearPrazoAll(){
  try{ localStorage.removeItem(LS_PRAZO_KEY); }catch(_e){}
  prazoByRal.clear();
}

const fDesignacao = el("fDesignacao");
  const fCF = el("fCF");
  const fRAL = el("fRAL");

  const tbody = el("tbody");
  const chart = el("chart");

  const outBox = el("outBox");
  const outTxt = el("outTxt");
let items = load();
  loadStatusMap();
  loadPrazoMap();
  let selectedRangeKey = ""; // filtro do gr√°fico (faixa)
  initTheme();

  // ====== Faixas (NOVAS) + Manchester ======
  // Ordem de criticidade (topo primeiro)
  const AGE_RANGES = [
    { key: "ACIMA_72", label: "Acima de 72h",  manchester: "red" },
    { key: "48_72",    label: "Entre 48h‚Äì72h", manchester: "red" },
    { key: "24_48",    label: "Entre 24h‚Äì48h", manchester: "red" },
    { key: "16_24",    label: "Entre 16h‚Äì24h", manchester: "orange" },
    { key: "8_16",     label: "Entre 8h‚Äì16h",  manchester: "yellow" },
    { key: "4_8",      label: "Entre 4h‚Äì8h",   manchester: "green" },
    { key: "ATE_4",    label: "At√© 4h",        manchester: "blue" },
  ];

  function manchesterColor(kind){
    switch(kind){
      case "red": return getCss("--m-red");
      case "orange": return getCss("--m-orange");
      case "yellow": return getCss("--m-yellow");
      case "green": return getCss("--m-green");
      case "blue": return getCss("--m-blue");
      default: return getCss("--m-blue");
    }
  }

  function getCss(varName){
    return getComputedStyle(document.body).getPropertyValue(varName).trim();
  }

  function rangeKeyForHours(hours) {
    if (hours >= 72) return "ACIMA_72";
    if (hours >= 48) return "48_72";
    if (hours >= 24) return "24_48";
    if (hours >= 16) return "16_24";
    if (hours >= 8)  return "8_16";
    if (hours >= 4)  return "4_8";
    return "ATE_4";
  }

  function rangeMeta(key) {
    return AGE_RANGES.find(r => r.key === key) || AGE_RANGES[AGE_RANGES.length - 1];
  }

  function rangeOrderIndex(key) {
    return AGE_RANGES.findIndex(r => r.key === key);
  }

  function save() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ items }));
  }

  function load() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed.items) ? parsed.items : [];
    } catch {
      return [];
    }
  }

  function normalize(s) {
    return (s ?? "").toString().trim().toLowerCase();
  }

  function escapeHtml(str) {
    return (str ?? "").toString()
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // RAL "compacta" para planilha (93056/2026)
  function ralNumeric(ral){
    return (ral ?? "").toString().trim().replace(/^RAL\s*-\s*/i, "");
  }

  function parseAbertura(line) {
    const m = line.match(/(\d{2}\/\d{2}\/\d{4})\s*-\s*(\d{2}:\d{2})/);
    if (!m) return null;
    const [dd, mm, yyyy] = m[1].split("/").map(Number);
    const [HH, MI] = m[2].split(":").map(Number);
    return new Date(yyyy, mm - 1, dd, HH, MI, 0, 0);
  }

  function findRAL(line) {
    // aceita "RAL-123/2026" e tamb√©m s√≥ "123/2026"
    const m1 = line.match(/\bRAL-\d+\/\d{4}\b/);
    if (m1) return m1[0];
    const m2 = line.match(/\b\d+\/\d{4}\b/);
    return m2 ? `RAL-${m2[0]}` : null;
  }

  function detectType(line) {
    if (line.includes("ACESSO CLIENTE")) return "ACESSO CLIENTE";
    if (line.includes("COLETOR")) return "COLETOR";
    return "";
  }

  function extractDesignacao(line, typeFound) {
    if (!typeFound) return line.trim();
    const idx = line.indexOf(typeFound);
    if (idx <= 0) return "";
    return line.slice(0, idx).trim();
  }

  function ageMs(dt) { return Date.now() - dt.getTime(); }

  function ageHuman(dt) {
    const ms = Math.max(0, ageMs(dt));
    const totalMinutes = Math.floor(ms / 60000);
    const days = Math.floor(totalMinutes / (60 * 24));
    const hours = Math.floor((totalMinutes % (60 * 24)) / 60);
    const minutes = totalMinutes % 60;
    const totalHours = ms / 3600000;
    return { days, hours, minutes, totalHours };
  }

  function formatAgeShort(a) { return `${a.days}d ${a.hours}h ${a.minutes}m`; }

  function normalizeCFPath(cf) {
    return (cf ?? "")
      .toString()
      .trim()
      .replace(/\s*\/\s*/g, "/")
      .replace(/\s{2,}/g, " ");
  }

  function extractCF(line) {
    if (line.includes("\t")) {
      const cols = line.split("\t").map(c => c.trim()).filter(Boolean);
      const ralIdx = cols.findIndex(c => /\bRAL-\d+\/\d{4}\b/.test(c) || /\b\d+\/\d{4}\b/.test(c));
      if (ralIdx >= 0) {
        const cfIdx = ralIdx + 4;
        if (cols[cfIdx] && cols[cfIdx].includes("/")) return normalizeCFPath(cols[cfIdx]);
      }
      const candidate = cols.find(c => c.includes("/") && /[A-Z]{2}\//.test(c));
      return candidate ? normalizeCFPath(candidate) : "";
    }

    const m = line.match(/\b\d+\b\s+([A-Z]{2}\/[A-Z0-9]+(?:\s*\/\s*[A-Z0-9]+)*)/);
    if (m) return normalizeCFPath(m[1]);

    const m2 = line.match(/([A-Z]{2}\/[A-Z0-9]+(?:\s*\/\s*[A-Z0-9]+)*)/);
    return m2 ? normalizeCFPath(m2[1]) : "";
  }

  function parseLines(text) {
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
    const parsed = [];
    const errors = [];

    for (const line of lines) {
      if (/^E\s*-\s*C$/i.test(line)) continue;

      // Descarta qualquer RAL de QUALIDADE (regra de neg√≥cio)
      if (/\bQUALIDADE\b/i.test(line)) { errors.push({ line, reason: "Descartada (QUALIDADE)" }); continue; }

      const ralFound = findRAL(line);
      if (!ralFound) { errors.push({ line, reason: "Sem RAL" }); continue; }

      const dt = parseAbertura(line);
      if (!dt) { errors.push({ line, reason: "Sem data/hora" }); continue; }

      const typeFound = detectType(line);
      const design = extractDesignacao(line, typeFound);

      const cfFound = extractCF(line);
      if (!cfFound) { errors.push({ line, reason: "Sem CF (path) detectado" }); continue; }

      parsed.push({
        id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
        ral: ralFound,
        aberturaISO: dt.toISOString(),
        designacao: design,
        cf: cfFound
      });
    }

    return { parsed, errors };
  }

  function mergeNoDuplicates(newItems) {
    const existing = new Set(items.map(x => normalize(x.ral)));
    let added = 0;
    for (const n of newItems) {
      const key = normalize(n.ral);
      if (existing.has(key)) continue;
      items.push(n);
      existing.add(key);
      added++;
    }
    return added;
  }

  function applyFilters(list) {
    const fd = normalize(fDesignacao.value);
    const fc = normalize(fCF.value);
    const fr = normalize(fRAL.value);

    return list.filter(x => {
      const d = normalize(x.designacao);
      const c = normalize(x.cf);
      const r = normalize(x.ral);

      if (selectedRangeKey) {
        const dt = new Date(x.aberturaISO);
        const a = ageHuman(dt);
        const key = rangeKeyForHours(a.totalHours);
        if (key !== selectedRangeKey) return false;
      }

      return (!fd || d.includes(fd)) && (!fc || c.includes(fc)) && (!fr || r.includes(fr));
    });
  }

  function removeItem(id) {
    if (!confirm("Remover este registro?")) return;
    items = items.filter(x => x.id !== id);
    save();
    render();
  }

  function clearAll() {
    if (!confirm("Apagar TUDO?")) return;


    // PRAZO (m√≥dulo): limpa todas as datas salvas (inclusive relat√≥rios antigos)
    clearPrazoAll();

    // limpa entrada (dados brutos)
    el("raw").value = "";

    // limpa filtros
    fDesignacao.value = "";
    fCF.value = "";
    fRAL.value = "";

    // limpa sa√≠das (TXT)
    outTxt.value = "";
    outBox.style.display = "none";

    // reseta dataset e sele√ß√£o
    items = [];
    selectedRangeKey = "";
    save();
    render();
  }
  function downloadFile(content, mime, filename) {
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.download = filename;
    a.href = url;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function stampName(prefix, ext) {
    const d = new Date();
    const pad = (n) => String(n).padStart(2,"0");
    return `${prefix}_${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}.${ext}`;
  }

  function fmtBR(dt){
    const pad = (n) => String(n).padStart(2,"0");
    return `${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()} - ${pad(dt.getHours())}:${pad(dt.getMinutes())}`;
  }

  // PRAZO em PT-BR (exibi√ß√£o): 2026-02-28 -> 28/02/2026
  function fmtPrazoBR(isoDate){
    const s = (isoDate || "").toString().trim();
    if(!/^\d{4}-\d{2}-\d{2}$/.test(s)) return "";
    const [y,m,d] = s.split("-");
    return `${d}/${m}/${y}`;
  }


  // PRAZO: formato de exibi√ß√£o (DD/MM/AAAA) para telas e exports
  function getPrazoForRalBR(ral){
    return fmtPrazoBR(getPrazoForRal(ral));
  }

  function updateColetaPill(list){
    if (!list.length) { rangeColeta.textContent = "-"; return; }
    const dts = list.map(x => new Date(x.aberturaISO)).sort((a,b)=>a-b);
    rangeColeta.textContent = `${fmtBR(dts[0])} ‚Üí ${fmtBR(dts[dts.length-1])}`;
  }

  // ====== Regras de neg√≥cio (CF -> Pir√¢mide / UF / Respons√°vel) ======
  function cfNorm(cf){
    return normalizeCFPath(cf).toUpperCase();
  }

  function endsWithCBS(cfN){ return cfN.endsWith("/CBS") || cfN.includes("/CBS"); }

  function piramideFromCF(cf){
    const c = cfNorm(cf);

    // 0) M√≥vel Agrega√ß√£o (CF final CLA/IP)
    if (/\/CLA\/IP\/?$/.test(c)) return "MOVEL AGREGA√á√ÉO";

// Regras espec√≠ficas solicitadas (prioridade alta)
if (c.includes("OM/BSA/SGS/DTC/BS")) return "REDE EXTERNA";
if (c.includes("OM/GNA/QZ/DTC/BS"))  return "REDE EXTERNA";


    // 1) Assist√™ncia T√©cnica
    if (c.startsWith("PR/")) return "ASSIST√äNCIA T√âCNICA";

    // 2) Swap
    if (c.includes("/SW")) return "SWAP";

    // 3) Infraestrutura
    if (c.includes("/EN") || c.includes("/AC") || c.includes("/INF")) return "INFRAESTRUTURA";

    // 4) Rede interna
    if (c.startsWith("TT/")) return "REDE INTERNA";
    if (c.includes("BKB/TX") || c.includes("BKB/CD") || c.includes("BKB/MT") || c.includes("RED/MT") || c.endsWith("RED") || c.endsWith("/RED") || c.endsWith("/RED/")) return "REDE INTERNA";

    // 5) Rede externa
    if (c.includes("CO/NET/FO") || c.includes("CBS")) return "REDE EXTERNA";

    return "N/D";
  }

  function ufFromCF(cf){
    const c = cfNorm(cf);

    // Ordem conforme solicitado (primeiro que bater, levou)
    if (c.includes("CPE") || c.includes("DOS") || c.includes("TLS")) return "MS";
    if (c.includes("BSA")) return "DF";
    if (c.includes("PMJ") || c.includes("GUR") || c.includes("ARN")) return "TO";
    if (c.includes("CBA") || c.includes("ROI") || c.includes("SNO") || c.includes("BAG") || c.includes("CCS")) return "MT";
    if (c.includes("GNA") || c.includes("ANS") || c.includes("RVD") || c.includes("JTI")) return "GO";
    if (c.includes("PVO") || c.includes("JIP")) return "RO";
    if (c.includes("RBO")) return "AC";
    return "";
  }

  function responsavelFromCF(cf){
    const c = cfNorm(cf);
    const isCBS = endsWithCBS(c);

// Regras AT/*/XXX/CLA/IP (prioridade m√°xima)
if (/AT\/CPE\/.+\/CLA\/IP/.test(c)) return "Edmar Almeida";
if (/AT\/GNA\/.+\/CLA\/IP/.test(c)) return "Valdir Donizetti";
if (/AT\/PVO\/.+\/CLA\/IP/.test(c)) return "Rodrigo Mozart";
if (/AT\/PMJ\/.+\/CLA\/IP/.test(c)) return "Atanagildo Jos√©";
if (/AT\/BSA\/.+\/CLA\/IP/.test(c)) return "Joaquim Ferreira";
if (/AT\/RBO\/.+\/CLA\/IP/.test(c)) return "Rodrigo Mozart";

// Regras espec√≠ficas solicitadas (prioridade m√°xima)
if (c.includes("AT/CBA/MC/CLA/IP")) return "Albino J√∫nior";
if (/\/SW$/.test(c)) return "F√°bio Torres / Francisco Manuel";
if (c.includes("OM/BSA/SGS/DTC/BS")) return "Dennys Rezende";
if (c.includes("OM/GNA/QZ/DTC/BS"))  return "M√°rcio Dias";

    // Mais espec√≠ficos primeiro
    if (c.includes("AT/GNA/RD/CLA/IP")) return "Ulysses Ant√¥nio";
    if (c.includes("BSA/CO/NET/FO")) return "Mario da Costa";

    if (c.includes("CPE/CO/NET/FO") || c.includes("DOS/CO/NET/FO") || c.includes("TLS/CO/NET/FO")) return "Romildo Longuinho";

    if (c.includes("CBA/CO/NET/FO") || c.includes("BAG/CO/NET/FO") || c.includes("CCS/CO/NET/FO") || c.includes("ROI/CO/NET/FO") || c.includes("SNO/CO/NET/FO")) return "Gilson Nogueira";

    if (c.includes("GNA/CO/NET/FO") || c.includes("ANS/CO/NET/FO") || c.includes("RVD/CO/NET/FO") || c.includes("JTI/CO/NET/FO")) return "Wendell Felippe";

    if (c.includes("PMJ/CO/NET/FO") || c.includes("ARN/CO/NET/FO") || c.includes("GUR/CO/NET/FO")) return "Alessandro Marques";

    if (c.includes("RBO/CO/NET/FO") || c.includes("PVO/CO/NET/FO") || c.includes("JIP/CO/NET/FO")) return "Joacyr Alencar";

    // Regras com exce√ß√£o CBS
    if (!isCBS && (c.includes("OM/CPE") || c.includes("PR/CPE") || c.includes("OM/DOS") || c.includes("PR/DOS") || c.includes("OM/TLS") || c.includes("PR/TLS"))) return "Edmar Castro";

    if (!isCBS && (c.startsWith("OM/BSA/") || c.startsWith("PR/BSA"))) return "Edgar Filho";

    if (!isCBS && (c.startsWith("OM/CBA") || c.startsWith("OM/BAG") || c.startsWith("OM/CCS") || c.startsWith("OM/ROI") || c.startsWith("OM/SNO") ||
                   c.startsWith("TT/CBA") || c.startsWith("TT/BAG") || c.startsWith("TT/CCS") || c.startsWith("TT/ROI") || c.startsWith("TT/SNO"))) return "Danielson Jose";

    if (!isCBS && (c.includes("OM/GNA") || c.includes("OM/ANS") || c.includes("OM/RVD") || c.includes("OM/JTI") ||
                   c.includes("TT/GNA") || c.includes("TT/ANS") || c.includes("TT/RVD") || c.includes("TT/JTI"))) return "M√°rcio Humberto/Edgar";

    if (c.includes("OM/PMJ") || c.includes("IM/PMJ") || c.includes("OM/ARN") || c.includes("OM/GUR") || c.includes("TT/PMJ") || c.includes("TT/ARN") || c.includes("TT/GUR")) return "Ajax Barbosa";

    if (!isCBS && (c.includes("OM/RBO") || c.includes("TT/RBO") || c.includes("OM/PVO") || c.includes("TT/PVO") || c.includes("JIP/PVO"))) return "Adriano Campigotto";

    if (c.includes("/EN") || c.includes("/AC") || c.includes("/INF")) return "Angelo Fraianeli";

    return "";
  }

  function prazoDefault(){
    // N√£o veio no dump. Mantive padr√£o (ajusta se voc√™ tiver a regra real).
    return "24h";
  }

  function statusDefault(){
    // N√£o veio no dump. Padr√£o ‚ÄúABERTA‚Äù.
    return "ABERTA";
  }

  function faixaIdadeLabelFromISO(iso){
    const dt = new Date(iso);
    const a = ageHuman(dt);
    return rangeMeta(rangeKeyForHours(a.totalHours)).label;
  }

  function buildDerivedRows(){
    const filtered = applyFilters(items);

    const rows = filtered.map(x => {
      const dt = new Date(x.aberturaISO);
      const a = ageHuman(dt);
      const key = rangeKeyForHours(a.totalHours);
      const meta = rangeMeta(key);
      return {
        x,
        key,
        meta,
        ageMs: ageMs(dt),
        faixa: meta.label,
        piramide: piramideFromCF(x.cf),
        uf: ufFromCF(x.cf),
        responsavel: responsavelFromCF(x.cf),
        status: getStatusForRal(x.ral),
      };
    });

    rows.sort((p,q) => {
      const byRange = rangeOrderIndex(p.key) - rangeOrderIndex(q.key);
      if (byRange !== 0) return byRange;
      return q.ageMs - p.ageMs;
    });

    return rows;
  }

  // ====== TXT (alinhado) NA TELA (7 colunas, sem PRAZO) ======
  function buildTxtAligned(){
    const rows = buildDerivedRows();

    const head = ["RAL","PIR√ÇMIDE","UF","CF","FAIXA DE IDADE","RESPONS√ÅVEL","PRAZO","STATUS"];
    const cols = [];
    cols.push(head);
    for (const r of rows){
      cols.push([
        r.x.ral,
        r.piramide,
        r.uf,
        r.x.cf,
        r.faixa,
        r.responsavel,
        getPrazoForRalBR(r.x.ral),
        r.status
      ]);
    }

    // calcula larguras (monoespa√ßado) para alinhar cabe√ßalho com os valores
    const widths = head.map((_,i)=>0);
    for (const row of cols){
      row.forEach((v,i)=>{
        const s = (v ?? "").toString();
        widths[i] = Math.max(widths[i], s.length);
      });
    }

    const pad = (s,n) => (s ?? "").toString().padEnd(n, " ");
    const lines = cols.map(row => row.map((v,i)=>pad(v,widths[i])).join("  "));
    return lines.join("\n");
  }


  function showOutTxt(){
    const rows = buildDerivedRows();
    if (!rows.length) { alert("Nada para gerar (n√£o h√° RALs vis√≠veis com os filtros atuais)."); return; }

    el("outTitle").textContent = "TXT (alinhado) gerado";
    el("outHint").textContent = "Texto alinhado em colunas (monoespa√ßado). Se quiser colunas no Excel, use Gerar CSV ou Baixar XLS.";
    outTxt.style.display = "block";
    el("outTableWrap").style.display = "none";

    outTxt.value = buildTxtAligned();
    outBox.style.display = "block";
    outTxt.scrollTop = 0;
    try{ outBox.scrollIntoView({behavior:"smooth", block:"start"}); }catch(_e){}
  }

  // ====== ‚ÄúExcel na tela‚Äù ======

  function applySlaHighlight(tr, ageKey, status){
    tr.classList.remove("sla24","sla48","sla72");
    if (status !== "ABERTA") return;
    if (ageKey === "24_48") tr.classList.add("sla24");
    else if (ageKey === "48_72") tr.classList.add("sla48");
    else if (ageKey === "ACIMA_72") tr.classList.add("sla72");
  }

  function showOutExcel(){
    const rows = buildDerivedRows();
    if (!rows.length) { alert("Nada para gerar (n√£o h√° RALs vis√≠veis com os filtros atuais)."); return; }

    el("outTitle").textContent = "Planilha (visual)";
    el("outHint").textContent = "Dica: se quiser abrir no Excel mesmo, use o bot√£o Baixar XLS (abre direto).";

    outTxt.style.display = "none";
    el("outTableWrap").style.display = "block";

    const outTbody = el("outTbody");
    outTbody.innerHTML = "";
    for (const r of rows){
      const tr = document.createElement("tr");
      tr.setAttribute("data-ral", r.x.ral);
      tr.setAttribute("data-agekey", r.key);
      applySlaHighlight(tr, r.key, r.status);
      tr.innerHTML = `
        <td class="mono">${escapeHtml(ralNumeric(r.x.ral))}</td>
        <td>${escapeHtml(r.piramide)}</td>
        <td class="mono ufCol">${escapeHtml(r.uf)}</td>
        <td class="mono cfCol">${escapeHtml(r.x.cf)}</td>
        <td>${escapeHtml(r.faixa)}</td>
        <td>${escapeHtml(r.responsavel)}</td>
        <td class="prazoCell">
          <div class="prazoWrap">
            <div class="prazoField">
              <input type="date" class="prazoInput" data-ral="${escapeHtml(r.x.ral)}" value="${escapeHtml(getPrazoForRal(r.x.ral))}">
              <button type="button" class="prazoBtn" title="Selecionar data" aria-label="Selecionar data">
                <span aria-hidden="true">üìÖ</span>
                <span class="prazoBtnText">${escapeHtml(fmtPrazoBR(getPrazoForRalBR(r.x.ral))) || ""}</span>
              </button>
            </div>
          </div>
        </td>
        <td>
          <select class=\"statusSel\" data-ral="${escapeHtml(r.x.ral)}">
            <option value="ABERTA"${r.status==="ABERTA"?" selected":""}>ABERTA</option>
            <option value="FECHADA"${r.status==="FECHADA"?" selected":""}>FECHADA</option>
            <option value="NORMALIZADA"${r.status==="NORMALIZADA"?" selected":""}>NORMALIZADA</option>
          </select>
        </td>
      `;
      outTbody.appendChild(tr);
    }

    // Status: dropdown na c√©lula (reflete nas exporta√ß√µes)
    outTbody.querySelectorAll(".statusSel").forEach(sel => {
      sel.addEventListener("change", (e) => {
        const ral = sel.getAttribute("data-ral");
        setStatusForRal(ral, sel.value);
        const tr = sel.closest("tr");
        const ageKey = tr ? tr.getAttribute("data-agekey") : "";
        if (tr) applySlaHighlight(tr, ageKey, sel.value);
        render();
      });
    });
    

// PRAZO: calend√°rio (m√≥dulo isolado) ‚Äî input[type=date] por cima de um bot√£o üìÖ (persistido em localStorage)
(function bindPrazoControls(scope){
  scope.querySelectorAll(".prazoField").forEach(field=>{
    const inp = field.querySelector(".prazoInput");
    const btn = field.querySelector(".prazoBtn");
    const txtEl = field.querySelector(".prazoBtnText");
    if(!inp || !btn) return;

    const setBtnLabel = () => {
      const label = fmtPrazoBR(inp.value || "");
      if(txtEl){
        txtEl.textContent = label || "";
        if(!label){
          txtEl.classList.add("prazoBtnEmpty");
        }else{
          txtEl.classList.remove("prazoBtnEmpty");
        }
      }
    };

    const openPicker = () => {
      try{ if(typeof inp.showPicker === "function") inp.showPicker(); }catch(_e){}
      inp.focus();
      inp.click();
    };

    // Clique no bot√£o ou na c√©lula abre o calend√°rio
    btn.addEventListener("click", openPicker);
    field.addEventListener("click", (e)=>{
      // evita duplo-disparo quando clicar no pr√≥prio bot√£o
      if(e.target && (e.target.closest && e.target.closest(".prazoBtn"))) return;
      openPicker();
    });

    inp.addEventListener("change", () => {
      const ral = inp.getAttribute("data-ral");
      setPrazoForRal(ral, inp.value || "");
      setBtnLabel();
    });

    setBtnLabel();
  });
})(outTbody);

outBox.style.display = "block";
    try{ outBox.scrollIntoView({behavior:"smooth", block:"start"}); }catch(_e){}
  }

  function buildExcelHtmlTable(){
    // Excel abre HTML como planilha, sem drama.
    const rows = buildDerivedRows();
    const head = ["RAL","PIR√ÇMIDE","UF","CF","FAIXA DE IDADE","RESPONS√ÅVEL","PRAZO","STATUS"];
    const escape = (s)=> (s??"").toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");

    let h = '<html><head><meta charset="utf-8"><style>table{border-collapse:collapse;font-family:Calibri,Arial,sans-serif;font-size:10pt;}th,td{padding:6px 8px;vertical-align:top;}td{white-space:normal;word-break:break-word;}</style></head><body>';
    h += '<table border="1"><thead><tr>' + head.map(c=>`<th>${escape(c)}</th>`).join("") + '</tr></thead><tbody>';
    for (const r of rows){
      const cols = [ralNumeric(r.x.ral),r.piramide,r.uf,r.x.cf,r.faixa,r.responsavel,getPrazoForRalBR(r.x.ral),getStatusForRal(r.x.ral)];
      h += "<tr>" + cols.map(v=>`<td>${escape(v)}</td>`).join("") + "</tr>";
    }
    h += '</tbody></table></body></html>';
    return h;
  }

  function downloadXls(){
    const rows = buildDerivedRows();
    if (!rows.length) { alert("Nada para baixar."); return; }
    const htmlTable = buildExcelHtmlTable();
    downloadFile(htmlTable, "application/vnd.ms-excel;charset=utf-8", stampName("rals_planilha", "xls"));
  }

  function copyOut(){
    const isTxt = outTxt.style.display !== "none";
    if (isTxt){
      navigator.clipboard.writeText(outTxt.value || "")
        .then(()=>alert("Copiado."))
        .catch(()=>alert("N√£o consegui acessar a √°rea de transfer√™ncia. Copie manualmente."));
    }else{
      // copia TSV (mais √∫til)
      const tsv = buildTsv8();
      navigator.clipboard.writeText(tsv)
        .then(()=>alert("Copiado (TSV)."))
        .catch(()=>alert("N√£o consegui acessar a √°rea de transfer√™ncia. Copie manualmente."));
    }
  }

  

// ====== TSV (para copiar/colar no Excel) ======
function tsvEscape(v){
  const s = (v ?? "").toString();
  // Excel/Sheets: tab separa colunas; remove tabs internas pra n√£o bagun√ßar
  return s.replace(/\t/g, " ").replace(/\r?\n/g, " ");
}

function buildTsv8(){
  const rows = buildDerivedRows();
  const head = ["RAL","PIR√ÇMIDE","UF","CF","FAIXA DE IDADE","RESPONS√ÅVEL","PRAZO","STATUS"];
  const lines = [];
  lines.push(head.join("\t"));
  for(const r of rows){
    lines.push([
      ralNumeric(r.x.ral),
      r.piramide,
      r.uf,
      r.x.cf,
      r.faixa,
      r.responsavel,
      getPrazoForRalBR(r.x.ral),
      getStatusForRal(r.x.ral),
    ].map(tsvEscape).join("\t"));
  }
  return lines.join("\n");
}

// ====== CSV (download) agora com 8 colunas tamb√©m ======
  function csvEscape(value) {
    const s = (value ?? "").toString();
    if (/[",\n]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
    return s;
  }

  function exportCsv() {
    const rows = buildDerivedRows();
    if (!rows.length) { alert("Nada para exportar."); return; }

    const lines = [];
    lines.push("RAL,PIR√ÇMIDE,UF,CF,FAIXA DE IDADE,RESPONS√ÅVEL,PRAZO,STATUS");
    for (const r of rows) {
      lines.push([
        csvEscape(r.x.ral),
        csvEscape(r.piramide),
        csvEscape(r.uf),
        csvEscape(r.x.cf),
        csvEscape(r.faixa),
        csvEscape(r.responsavel),
        csvEscape(getPrazoForRalBR(r.x.ral)),
        csvEscape(getStatusForRal(r.x.ral)),
      ].join(","));
    }
    downloadFile(lines.join("\n"), "text/csv;charset=utf-8", stampName("rals", "csv"));
  }

  function renderChart(rows){
    // rows j√° vem filtrado (sem filtro de faixa), porque o chart deve mostrar o "mapa inteiro"
    const counts = {};
    AGE_RANGES.forEach(r => counts[r.key] = 0);
    for (const r of rows){
      counts[r.key] = (counts[r.key] || 0) + 1;
    }
    const max = Math.max(1, ...Object.values(counts));

    chart.innerHTML = "";
    for (const range of AGE_RANGES){
      const n = counts[range.key] || 0;
      const pct = Math.round((n / max) * 100);

      const row = document.createElement("div");
      row.className = "barRow";

      const btn = document.createElement("button");
      btn.className = "barBtn";
      if (selectedRangeKey === range.key) btn.classList.add("selected");
      btn.setAttribute("data-range", range.key);

      const label = document.createElement("div");
      label.className = "barLabel";
      label.innerHTML = `<span class="dot" style="background:${manchesterColor(range.manchester)}"></span>${escapeHtml(range.label)}`;

      const track = document.createElement("div");
      track.className = "barTrack";

      const fill = document.createElement("div");
      fill.className = "barFill";
      fill.style.width = `${pct}%`;
      fill.style.background = manchesterColor(range.manchester);
      track.appendChild(fill);

      const meta = document.createElement("div");
      meta.className = "barMeta";
      meta.textContent = n === 1 ? "1 RAL" : `${n} RALs`;

      btn.appendChild(label);
      btn.appendChild(track);
      btn.appendChild(meta);

      const right = document.createElement("div");
      right.className = "mono";
      right.style.textAlign = "right";
      right.textContent = String(n);

      row.appendChild(btn);
      row.appendChild(document.createElement("div")); // spacer
      row.appendChild(right);
      chart.appendChild(row);

      btn.addEventListener("click", () => {
        const key = btn.getAttribute("data-range");
        selectedRangeKey = (selectedRangeKey === key) ? "" : key;
        render();
      });
    }
  }

  function render() {
    count.textContent = String(items.length);

    // Coleta √© sobre o conjunto total (n√£o filtrado), como voc√™ pediu
    updateColetaPill(items);

    const filtered = applyFilters(items);

    // Contadores e p√≠lulas extras foram removidos do cabe√ßalho para deixar a UI mais limpa.
    // Se quiser reativar KPIs no futuro, √© s√≥ recolocar os elementos no header e plugar aqui.


    // Chart deve ignorar o filtro de faixa (sen√£o ele vira "espelho" do pr√≥prio clique)
    const chartBase = items.map(x => {
      const dt = new Date(x.aberturaISO);
      const a = ageHuman(dt);
      const key = rangeKeyForHours(a.totalHours);
      const meta = rangeMeta(key);
      return { x, a, key, meta, ageMs: ageMs(dt) };
    });
    renderChart(chartBase);

    // Table
    const rows = filtered.map(x => {
      const dt = new Date(x.aberturaISO);
      const a = ageHuman(dt);
      const key = rangeKeyForHours(a.totalHours);
      const meta = rangeMeta(key);
      return { x, a, key, meta, ageMs: ageMs(dt) };
    });

    rows.sort((p,q) => {
      const byRange = rangeOrderIndex(p.key) - rangeOrderIndex(q.key);
      if (byRange !== 0) return byRange;
      return q.ageMs - p.ageMs;
    });

    tbody.innerHTML = "";
    if (rows.length === 0) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 5;
      td.className = "muted";
      td.style.padding = "14px";
      td.textContent = "Sem registros para mostrar (ou filtros apertaram demais).";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    for (const r of rows) {
      const dotColor = manchesterColor(r.meta.manchester);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>
          <span class="badge">
            <span class="dot" style="background:${dotColor}"></span>
            ${escapeHtml(r.meta.label)}
          </span>
          <div class="ageSub mono">${escapeHtml(formatAgeShort(r.a))}</div>
        </td>
        <td class="mono">${escapeHtml(ralNumeric(r.x.ral))}</td>
        <td>${escapeHtml(r.x.designacao)}</td>
        <td class="mono">${escapeHtml(r.x.cf)}</td>
        <td><button class="danger small" data-del="${r.x.id}">Remover</button></td>
      `;
      tbody.appendChild(tr);
    }

    tbody.querySelectorAll("button[data-del]").forEach(btn => {
      btn.addEventListener("click", () => removeItem(btn.getAttribute("data-del")));
    });
  }

  // ====== Theme ======
  function initTheme(){
    const saved = localStorage.getItem(THEME_KEY);
    const theme = (saved === "light" || saved === "dark") ? saved : "dark";
    document.body.setAttribute("data-theme", theme === "light" ? "light" : "dark");
  }

  function toggleTheme(){
    const current = document.body.getAttribute("data-theme") === "light" ? "light" : "dark";
    const next = current === "light" ? "dark" : "light";
    document.body.setAttribute("data-theme", next);
    localStorage.setItem(THEME_KEY, next);
    render(); // refaz cores do chart
  }

  el("btnTheme").addEventListener("click", toggleTheme);

  // ====== Events ======
  el("btnParse").addEventListener("click", () => {
    const text = raw.value || "";
    if (!text.trim()) { alert("Cole os dados brutos primeiro."); return; }

    const { parsed, errors } = parseLines(text);
    const added = mergeNoDuplicates(parsed);

    save();
    render();

    const msg = [];
    msg.push("Importa√ß√£o conclu√≠da.");
    msg.push(`Adicionados: ${added}`);
    msg.push(`Ignorados (duplicados): ${parsed.length - added}`);
    msg.push(`Linhas ignoradas (erro): ${errors.length}`);

    if (errors.length) {
      msg.push("");
      msg.push("Amostra (at√© 5):");
      errors.slice(0,5).forEach(e => msg.push(`- ${e.reason}: ${e.line}`));
    }
    alert(msg.join("\n"));
  });

  el("btnTxt").addEventListener("click", showOutTxt);
  el("btnXls").addEventListener("click", () => {
    try{ showOutExcel(); }
    catch(e){
      console.error(e);
      alert("Erro ao gerar Planilha (visual): " + (e && e.message ? e.message : e));
    }
  });
  el("btnCsv").addEventListener("click", exportCsv);

  el("btnCopyOut").addEventListener("click", copyOut);
  el("btnDownloadXls").addEventListener("click", downloadXls);
  el("btnCloseOut").addEventListener("click", () => { outBox.style.display = "none"; });

  el("btnClear").addEventListener("click", clearAll);

  el("btnResetStatus").addEventListener("click", () => {
    const ok = confirm("Isso vai apagar todos os STATUS salvos (localStorage) e voltar tudo para ABERTA. Confirma?");
    if(!ok) return;
    try{ localStorage.removeItem(LS_STATUS_KEY); }catch(e){}
    statusByRal.clear();
    // Atualiza UI atual (se houver tabela aberta)
    document.querySelectorAll(".statusSel").forEach(sel => { sel.value = "ABERTA"; });
  });

  el("btnResetFilters").addEventListener("click", () => {
    fDesignacao.value = "";
    fCF.value = "";
    fRAL.value = "";
    render();
  });

  el("btnClearRange").addEventListener("click", () => {
    selectedRangeKey = "";
    render();
  });

  [fDesignacao, fCF, fRAL].forEach(inp => inp.addEventListener("input", render));

  render();
})();

</script>
</body>
</html>
